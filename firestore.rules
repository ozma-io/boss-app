rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validation functions for required fields
    
    /**
     * Check if User document has all required fields
     * Required: email, createdAt, name, goal, position
     */
    function hasRequiredUserFields(data) {
      return data.keys().hasAll(['email', 'createdAt', 'name', 'goal', 'position']);
    }
    
    /**
     * Check if Boss document has all required fields
     * Required: name, position, birthday, managementStyle, startedAt, createdAt, updatedAt
     */
    function hasRequiredBossFields(data) {
      return data.keys().hasAll([
        'name',
        'position',
        'birthday',
        'managementStyle',
        'startedAt',
        'createdAt',
        'updatedAt'
      ]);
    }
    
    /**
     * Ensure required fields are not deleted during update
     * Checks that no required fields were explicitly removed
     * Custom fields (starting with custom_) can be deleted freely
     */
    function requiredFieldsNotDeleted(requiredFields) {
      let removedKeys = request.resource.data.diff(resource.data).removedKeys();
      return !removedKeys.hasAny(requiredFields);
    }
    
    /**
     * Ensure technical fields are not modified
     * Technical fields: email, createdAt (for both User and Boss)
     */
    function technicalFieldsNotModified(technicalFields) {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return !affectedKeys.hasAny(technicalFields);
    }

    // Users collection - users can only access their own data
    match /users/{userId} {
      // Create: must have required fields
      allow create: if isOwner(userId) && hasRequiredUserFields(request.resource.data);
      
      // Update: 
      // - Required fields must not be deleted
      // - Technical fields (email, createdAt) must not be modified
      // - Custom fields (custom_*) can be added/modified/deleted freely
      // - Regular fields (name, goal, position) can be modified
      allow update: if isOwner(userId) 
                    && requiredFieldsNotDeleted(['email', 'createdAt', 'name', 'goal', 'position'])
                    && technicalFieldsNotModified(['email', 'createdAt']);
      
      // Read and delete: owner only
      allow read, delete: if isOwner(userId);
      
      // Bosses subcollection
      match /bosses/{bossId} {
        // Create: must have required fields
        allow create: if isOwner(userId) && hasRequiredBossFields(request.resource.data);
        
        // Update:
        // - Required fields must not be deleted
        // - Technical field (createdAt) must not be modified
        // - Custom fields (custom_*) can be added/modified/deleted freely
        // - Regular fields (name, position, birthday, managementStyle, startedAt, updatedAt) can be modified
        allow update: if isOwner(userId) 
                      && requiredFieldsNotDeleted([
                        'name',
                        'position',
                        'birthday',
                        'managementStyle',
                        'startedAt',
                        'createdAt',
                        'updatedAt'
                      ])
                      && technicalFieldsNotModified(['createdAt']);
        
        // Read and delete: owner only
        allow read, delete: if isOwner(userId);
        
        // Entries subcollection (notes with subtypes, facts)
        match /entries/{entryId} {
          allow read, write: if isOwner(userId);
        }
      }
      
      // Chat threads and messages subcollection
      match /chatThreads/{threadId} {
        allow read, write: if isOwner(userId);
        
        match /messages/{messageId} {
          allow read, write: if isOwner(userId);
        }
      }
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
